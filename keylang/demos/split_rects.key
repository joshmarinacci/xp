@board("canvas")

//screen and system and the colors are already declared and in scope

var DIRECTIONS
var rects
fun do_splits(rect,depth) {
    if (depth < 0) {
        return List(rect)
    }
    var dir = choose(DIRECTIONS)
    var parts = rect.split(dir,randf(0.2,0.8))
    return List(do_splits(parts.get(0),depth-1), do_splits(parts.get(1),depth-1))
}

//this function is used by the others
fun drawRect(rect, time) {
    var theta = Math.sin(time/100 * (0.5 + rect.frequency) + rect.phase)
    var t = remap(theta, -1, 1, 0, 1)
    if (t < 0.5) {
        t = t/2
    } else {
        t = 1-t
    }
    var sat = lerp(t, 0.2, 0.8)
    var lit = lerp(t, 0.2, 1.0)
    screen.fillRect(rect, HSL(rect.hue,sat,lit))
    screen.strokeRect(rect, BLACK)
}

//this will be called once at app start
@type("start",setup)
fun setup() {
    DIRECTIONS = List("h","v")
    var outp = do_splits(screen,4)
    console.log("output",outp)
    var flat = outp.flatten()
    console.log("flat",flat)
    rects = flat
    rects.every((r)=>{
    r.hue = randf(0,1)
    r.phase = randf(0,1)
        r.frequency = randf(0.2,1.5)
    })
}

// this will be called every 0.3 seconds
@type("loop",loop, 0.5)
fun loop() {
    rects.every((rect) => { drawRect(rect,system.time) })
}

