<html>
    <head>
        <style lang="text/css">
        .grid {
            border: 1px solid black;
            display: grid;
            grid-template-columns: repeat(8, 40px);
            grid-template-rows: repeat(4, 40px);
            margin: 1rem;
        }
        .note {
            /* width: 10px; */
            /* height: 40px; */
            border: 1px solid black;
            border-width: 0 1px 1px 0;
            background-color: white;
        }
        .note.on {
            background-color: red;
        }
        .note.active {
            background-color: aqua;
        }
        .note.on.active {
            background-color: blue;
        }
        </style>
    </head>
    <body>
        <h1>synth test 1 for ToneJS</h1>

        <button id="tone-play-toggle">play</button>
        <input type="range" min="60" max="160" id="bpm">
        <label id="bpm-label">lll</label>
        <script src="node_modules/tone/build/Tone.js"></script>
        <script type="module">


class Grid {
    constructor(w,h) {
        this.w = w
        this.h = h
        this.data = new Array(w*h)
        this.data.fill(0)
    }
    mapAll(cb) {
        for(let y=0; y<this.h; y++) {
            for(let x=0; x<this.w; x++) {
                this.set(x,y,cb(x,y,this.get(x,y)))
            }
        }
    }
    forColumn(c,cb) {
        for(let y=0; y<this.h; y++) {
            cb(c,y,this.get(c,y))
        }
    }
    get(x,y) {
        return this.data[this.xy2n(x,y)]
    }
    set(x,y,value) {
        this.data[this.xy2n(x,y)] = value
    }
    xy2n(x,y) {
        return y*this.w+x
    }
}

function make_sequencer(grid, toggle_step) {
    let wrapper = document.createElement('div')
    wrapper.classList.add("grid")
    for(let y=0; y<grid.h; y++) {
        for(let x=0; x<grid.w; x++) {
            let cell = document.createElement('div')
            cell.classList.add("note")
            cell.setAttribute("data-x",x)
            cell.setAttribute("data-y",y)
            cell.addEventListener('mousedown',toggle_step)
            wrapper.appendChild(cell)
            grid.get(x,y).dom = cell
        }
    }
    return wrapper;
}

class BeatSeq {
    constructor(synths, notes, len) {
        this.synths = synths
        this.notes = notes
        this.grid = new Grid(len,synths.length)
        this.grid.mapAll((x,y,v) => ({
            on:false,
            active:false,
        }))
        this.count = -1
        this.toggle_step = (e) => {
            let x = parseInt(e.target.getAttribute("data-x"))
            let y = parseInt(e.target.getAttribute("data-y"))
            let v = this.grid.get(x,y)
            v.on = !v.on
            this.grid.set(x,y,v)
            if(v.on) e.target.classList.add('on')
            if(!v.on) e.target.classList.remove('on')
        }
    }
    render(root) {
        let div =  make_sequencer(this.grid, this.toggle_step)
        div.style.width = (this.grid.w*40)+"px"
        div.style.height = (this.grid.h*40)+"px"
        div.style.gridTemplateColumns = `repeat(${this.grid.w},40px)`
        div.style.gridTemplateRows    = `repeat(${this.grid.h},'40px')`
        return div
    }
    triggerNext() {
        if(this.count >= 0) {
            let oldc = this.count%this.grid.w
            this.grid.forColumn(oldc,(x,y,v)=>{
                v.active = false
                v.dom.classList.remove("active")
            })
        }
        this.count++
        let newc = this.count%this.grid.w
        this.grid.forColumn(newc,(x,y,v)=>{
            v.active = true
            v.dom.classList.add("active")
        })

        this.grid.forColumn(newc, (x,y,v)=>{
            let sy = this.synths[y]
            let ny = this.notes[y]
            if(v.on)  {
                if(ny === "NONE") {
                    sy.triggerAttackRelease()
                } else {
                    sy.triggerAttackRelease(ny,"8n")
                }
            }
        })
    }
}

// const kick = new Tone.MembraneSynth().toDestination()
const bop = new Tone.MembraneSynth().toDestination()
// const feedbackDelay = new Tone.PingPongDelay({
// 			"delayTime" : "8t",
// 			"feedback" : 0.25,
// 			"wet" : 0.25
// 		}).toDestination();

const snare = new Tone.NoiseSynth({
    "volume" : -5,
    "envelope" : {
        "attack" : 0.001,
        "decay" : 0.2,
        "sustain" : 0
    },
    "filterEnvelope" : {
        "attack" : 0.001,
        "decay" : 0.1,
        "sustain" : 0
    }
// }).connect(feedbackDelay);
}).toDestination()

var autoWah = new Tone.AutoWah(120, 10, -20).toDestination()
	var bass = new Tone.MonoSynth({
			"volume" : -10,
			"envelope" : {
				"attack" : 0.1,
				"decay" : 0.3,
				"release" : 2,
			},
			"filterEnvelope" : {
				"attack" : 0.001,
				"decay" : 0.01,
				"sustain" : 0.5,
				"baseFrequency" : 200,
				"octaves" : 2.6
			}
		}).connect(autoWah);


const kick = new Tone.MembraneSynth({
			"envelope" : {
				"sustain" : 0,
				"attack" : 0.02,
				"decay" : 0.8
			},
			"octaves" : 10
		}).toMaster();



let seq1 = new BeatSeq([kick,snare],["C2","NONE"],8)
document.body.appendChild(seq1.render())


const poly = new Tone.Synth({
	"volume": 0,
	"detune": 0,
	"portamento": 0.05,
	"envelope": {
		"attack": 0.05,
		"attackCurve": "exponential",
		"decay": 0.2,
		"decayCurve": "exponential",
		"release": 1.5,
		"releaseCurve": "exponential",
		"sustain": 0.2
	},
	"oscillator": {
		"partialCount": 0,
		"partials": [],
		"phase": 0,
		"type": "amtriangle",
		"harmonicity": 0.5,
		"modulationType": "sine"
	}
}).toDestination()
        
let seq2 = new BeatSeq([bass],["D2"],16)
document.body.appendChild(seq2.render())

const $ = (sel) => document.querySelector(sel)
const on = (el, type, cb) => el.addEventListener(type,cb)
Tone.Transport.scheduleRepeat((time)=> {
        seq1.triggerNext()
        seq2.triggerNext()
    },"4n")

    Tone.Transport.bpm.value = 120
on($("#tone-play-toggle"),'click',() => {
    Tone.Transport.toggle();
    let state = Tone.Transport.state
    if(state === 'stopped' || state === 'paused') {
        $("#tone-play-toggle").innerText = "play"
    }
    if(state === 'started') {
        $("#tone-play-toggle").innerText = "pause"
    }
})


on($("#bpm"),'change',(e) => {
    let v = parseFloat(e.target.value)
    Tone.Transport.bpm.value = v
    $("#bpm-label").innerText = `${v} BPB`
})

//document.querySelector("tone-play-toggle").addEventListener("start", () => Tone.Transport.start());
// document.querySelector("tone-play-toggle").addEventListener("stop", () => Tone.Transport.stop());
// document.querySelector("tone-slider").addEventListener("input", (e) => Tone.Transport.bpm.value = parseFloat(e.target.value));
// document.querySelector("tone-step-sequencer").addEventListener("trigger", ({ detail }) => {
    // keys.player(detail.row).start(detail.time, 0, "16t");
// });




        </script>
    </body>
</html>